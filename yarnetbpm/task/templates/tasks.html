{% extends 'index.html' %}

{% load static %}

{% block header %}
  Список задач
{% endblock header %}

{% block styles %}
  <link href="{% static ''%}assets/plugins/select2/select2.min.css" rel="stylesheet" />
{% endblock styles %}

{% block task_sidebar %}
  <form class="d-flex flex-column h-100" action="new_task/" method="POST">
    <h1 class="m-0 mb-5">Создание задачи</h1>

    <div class="border-bottom mb-5">
      <div class="mb-5">
        <label class="form-label">Название органа</label>
        <select class="form-control form-select" data-placeholder="Выберите компанию" name="company" role="button" required>
          {% for company in company_list %}
            <option value="{{ company.id }}">
              {{ company.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-5">
        <label class="form-label">Район</label>
        <select class="form-control form-select" data-placeholder="Выберите район" name="district" role="button" required>
          {% for district in districts %}
            <option value="{{ district.0 }}">
              {{ district.1 }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-5">
        <label class="form-label">Вид нарушения</label>
        <select class="form-control form-select" data-placeholder="Выберите вид нарушения" name="violation" role="button" required>
          {% for violation in violation_list %}
            <option value="{{ violation.id }}">
              {{ violation.species }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="mb-5">
        <label class="form-label">Номер акта</label>
        <input class="form-control form-control-lg w-50" placeholder="000 000" name="number" required />
      </div>

      <div class="mb-5">
        <label class="form-label">Сотрудник, составивший акт</label>
        <select class="form-control form-select" data-placeholder="Выберите сотрудника" name="user" role="button" required>
          {% for user in user_list %}
            <option value="{{ user.id }}">
              {{ user.fullname }}
            </option>
          {% endfor %}
        </select>
      </div>
    </div>
    
    <div class="d-flex flex-column w-100 align-self-end mt-auto">
      <button type="submit" class="btn btn-success btn-lg mb-3">Создать заявку</button>
      <button type="button" class="btn btn-light btn-lg">Архивировать</button>
    </div>
  </form>
{% endblock task_sidebar %}

{% block body %}
  <div class="d-flex flex-row justify-content-end bg-transparent my-2">
    <button type="button" class="btn btn-info" id="new-task-button">
      <i class="fe fe-plus mr-2"></i>
      Новое правонарушение
    </button>
  </div>

  <div class="card shadow-none" style="margin-top: 30px">
    <div class="table-responsive">
      <table class="table card-table table-vcenter text-nowrap mb-0">
        <thead >
          <tr>
            <th class="py-5 text-capitalize task__table-header">Орган</th>
            <th class="py-5 text-capitalize task__table-header">Район</th>
            <th class="py-5 text-capitalize task__table-header">Вид нарушения</th>
            <th class="py-5 text-capitalize task__table-header">Подвид нарушения</th>
            <th class="py-5 text-capitalize task__table-header">Дата акта</th>
            <th class="py-5 text-capitalize task__table-header">№ акта</th>
            <th class="py-5 text-capitalize task__table-header">Сотрудник</th>
            <th class="py-5 text-capitalize task__table-header">Статус</th>
            <th class="py-5 text-capitalize task__table-header">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for task in task_list %}
            <tr class="{% if task.regulation.status.lower == 'не рассмотрен' %} task__arrears {% endif %}">
              <td scope="row" class="task__table-row">
                {{ task.company.name }}
              </td>

              <td class="task__table-row">
                {{ task.district }}
              </td>

              <td class="task__table-row">
                {{ task.violation.name }}
              </td>

              <td class="task__table-row">
                {% comment %} {% for subs in task.violation.get_subspecies %}
                  <p class="p-0 m-0">
                    {{ subs.name }}
                  </p>
                {% endfor %} {% endcomment %}
              </td>

              <td class="task__table-row">
                {{ task.date|date:"H:i m.d.Y" }}
              </td>

              <td class="task__table-row">
                № {{ task.number }}
              </td>

              <td class="task__table-row">
                {{ task.user.fullname }}
              </td>

              <td class="
                {% if task.regulation.status.lower == 'на рассмотрении' %} task__cons
                {% elif task.regulation.status.lower == 'на согласовании' %} task__approval
                {% elif task.regulation.status.lower == 'не рассмотрен' %} task__status-arrears
                {% endif %}
              ">
                {{ task.regulation.status }}
              </td>

              <td class="task__table-row">
                <form method="POST" action="">
                  <input type="hidden" name="task_id" value="{{ task.id }}">

                  {% if task.regulation.get_next|length != 0 %}
                    {% for next in task.regulation.get_next %}
                      <button
                        class="btn
                          {% if next.button.lower == 'прикрепить акт' %} btn-outline-info
                          {% elif next.button.lower == 'рассмотрено' %} btn-outline-success
                          {% elif next.button.lower == 'согласовано' %} btn-outline-warning
                          {% endif %}
                        "
                        name="next_id"
                        value="{{ next.id }}"
                      >
                        {{ next.button }}
                      </button>
                    {% endfor %}
                  {% else %}
                    <button class="btn btn-outline-success">
                      <i class="fe fe-check mr-2"></i>

                      {{ next.button }} Завершить задачу
                    </button>
                  {% endif %}
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

{% endblock body %}

{% block scripts %}  
{% endblock scripts %}